# Copyright (c) 2020 The Orbit Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

cmake_minimum_required(VERSION 3.15)

project(cogen C CXX)
set(CMAKE_CXX_STANDARD 17)

set(GENERATED_DIR ${CMAKE_CURRENT_BINARY_DIR}/generated)
# The manifest file is generated by the generator. It is a summary of the code generation. 
# The generator is run automatically whenever this file is deleted.
set(GENERATOR_MANIFEST_FILE ${GENERATED_DIR}/blah.cpp)


project(generator)
add_executable(generator main.cpp)
# Remove the generated directory when rebuilding the generator so as to force re-generation.
add_custom_command(
TARGET generator
COMMAND ${CMAKE_COMMAND} -E remove -f ${GENERATOR_MANIFEST_FILE}
COMMENT "Deleting manifest file"
)

# Code generation is triggered when ${GENERATOR_MANIFEST_FILE} is missing.
add_custom_target( run_generator DEPENDS ${GENERATOR_MANIFEST_FILE} )
add_custom_command(
OUTPUT ${GENERATOR_MANIFEST_FILE}
COMMAND generator
COMMENT "Running Custom Command to generate code"
)

file(GLOB WINDOWS_API_SHIM_SOURCE ${GENERATED_DIR}/*.*)

# 
project(shim)
#add_executable(shim ${CMAKE_CURRENT_BINARY_DIR}/generated/blah.cpp)
add_executable(shim ${GENERATOR_MANIFEST_FILE} ${WINDOWS_API_SHIM_SOURCE})
add_dependencies(shim run_generator)



